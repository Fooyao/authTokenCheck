name: Build and Release

# è§¦å‘æ¡ä»¶ï¼šå½“æŽ¨é€tagæ—¶è‡ªåŠ¨è§¦å‘
on:
  push:
    tags:
      - 'v*.*.*'  # åŒ¹é… v1.0.0, v2.1.3 ç­‰ç‰ˆæœ¬å·æ ¼å¼
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  GO_VERSION: '1.21'

jobs:
  build:
    name: Build for multiple platforms
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # å®šä¹‰éœ€è¦ç¼–è¯‘çš„ç›®æ ‡å¹³å°
        include:
          - goos: windows
            goarch: amd64
            suffix: .exe
            name: windows-amd64
          - goos: windows
            goarch: 386
            suffix: .exe
            name: windows-386
          - goos: linux
            goarch: amd64
            suffix: ''
            name: linux-amd64
          - goos: linux
            goarch: arm64
            suffix: ''
            name: linux-arm64
          - goos: darwin
            goarch: amd64
            suffix: ''
            name: macos-amd64
          - goos: darwin
            goarch: arm64
            suffix: ''
            name: macos-arm64

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}

    - name: Cache Go modules
      uses: actions/cache@v3
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Download dependencies
      run: go mod download

    - name: Verify dependencies
      run: go mod verify

    - name: Run tests
      run: go test -v ./...

    - name: Build binary
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
        CGO_ENABLED: 0
      run: |
        mkdir -p dist
        output_name="twitter-checker-${{ matrix.name }}${{ matrix.suffix }}"
        go build -ldflags="-s -w -X main.version=${{ github.ref_name }}" -o "dist/${output_name}" main.go
        
        # åˆ›å»ºåŽ‹ç¼©åŒ…
        cd dist
        if [ "${{ matrix.goos }}" = "windows" ]; then
          zip "${output_name%.exe}.zip" "${output_name}"
        else
          tar -czf "${output_name}.tar.gz" "${output_name}"
        fi

    - name: Upload artifacts
      uses: actions/upload-artifact@v3
      with:
        name: twitter-checker-${{ matrix.name }}
        path: |
          dist/twitter-checker-${{ matrix.name }}*
        retention-days: 5

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v3
      with:
        path: artifacts

    - name: Prepare release files
      run: |
        mkdir -p release
        find artifacts -name "*.zip" -o -name "*.tar.gz" | xargs -I {} cp {} release/
        ls -la release/

    - name: Generate checksums
      run: |
        cd release
        sha256sum * > checksums.txt
        cat checksums.txt

    - name: Extract release notes
      id: extract_notes
      run: |
        # å°è¯•ä»ŽCHANGELOG.mdæˆ–gitæäº¤ä¸­æå–å‘å¸ƒè¯´æ˜Ž
        if [ -f "CHANGELOG.md" ]; then
          # æå–å½“å‰ç‰ˆæœ¬çš„æ›´æ–°æ—¥å¿—
          awk '/^## \[?'${GITHUB_REF#refs/tags/}'/{flag=1;next}/^## \[?[0-9]/{flag=0}flag' CHANGELOG.md > release_notes.txt
        else
          # ä½¿ç”¨gitæäº¤ä¿¡æ¯ä½œä¸ºå‘å¸ƒè¯´æ˜Ž
          echo "## æ›´æ–°å†…å®¹" > release_notes.txt
          echo "" >> release_notes.txt
          git log $(git describe --tags --abbrev=0 HEAD^)..HEAD --pretty=format:"- %s" >> release_notes.txt
          echo "" >> release_notes.txt
          echo "" >> release_notes.txt
          echo "## ä¸‹è½½è¯´æ˜Ž" >> release_notes.txt
          echo "- **Windowsç”¨æˆ·**: ä¸‹è½½ \`twitter-checker-windows-*.zip\`" >> release_notes.txt
          echo "- **Linuxç”¨æˆ·**: ä¸‹è½½ \`twitter-checker-linux-*.tar.gz\`" >> release_notes.txt
          echo "- **macOSç”¨æˆ·**: ä¸‹è½½ \`twitter-checker-macos-*.tar.gz\`" >> release_notes.txt
          echo "" >> release_notes.txt
          echo "## å®‰è£…æ–¹æ³•" >> release_notes.txt
          echo "1. ä¸‹è½½å¯¹åº”å¹³å°çš„åŽ‹ç¼©åŒ…" >> release_notes.txt
          echo "2. è§£åŽ‹åˆ°ä»»æ„ç›®å½•" >> release_notes.txt
          echo "3. åœ¨ç»ˆç«¯/å‘½ä»¤è¡Œä¸­è¿è¡Œ: \`./twitter-checker accounts.txt\`" >> release_notes.txt
          echo "" >> release_notes.txt
          echo "## æ ¡éªŒå’Œ" >> release_notes.txt
          echo "è¯·ä½¿ç”¨ \`checksums.txt\` æ–‡ä»¶éªŒè¯ä¸‹è½½æ–‡ä»¶çš„å®Œæ•´æ€§ã€‚" >> release_notes.txt
        fi

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: Release ${{ github.ref_name }}
        body_path: release_notes.txt
        files: |
          release/*
        draft: false
        prerelease: ${{ contains(github.ref_name, '-') }}
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Update latest release info
      run: |
        echo "âœ… Release ${{ github.ref_name }} created successfully!"
        echo "ðŸ“¦ Available downloads:"
        ls -la release/
        echo ""
        echo "ðŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}" 